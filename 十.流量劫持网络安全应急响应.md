# 流量劫持网络安全应急响应

## 10.1　流量劫持概述

### 10.1.1　流量劫持简介

流量劫持在网络安全事件中比较常见，它是一种通过在应用系统中植入恶意代码、在网络中部署恶意设备、使用恶意软件等手段，控制客户端与服务端之间的流量通信、篡改流量数据或改变流量走向，造成非预期行为的网络攻击技术。我们在日常生活中经常遇到的流氓软件、广告弹窗、网址跳转等都是流量劫持的表现形式。

#### 流量劫持的主要的目的如下：

（1）引流推广；

（2）钓鱼攻击；

（3）访问限制；

（4）侦听窃密。

### 10.1.2　常见流量劫持

根据影响的协议、网络的不同，流量劫持可大致分为：DNS劫持、HTTP劫持、链路层劫持等。

#### 1.DNS劫持

DNS（Domain Name System，域名系统）是一项互联网服务，用于网站域名与IP地址的相互转换。任何连接互联网的设备都会有一个唯一的IP地址，可以通过这个IP地址访问该设备。DNS支持TCP协议和UDP协议，默认端口为53。当前，对于每一级域名的长度限制是63个字符，域名的总长度则不能超过253个字符

DNS劫持又称域名劫持，是指控制DNS查询解析的记录，在劫持的网络中拦截DNS请求，分析匹配请求域名，返回虚假IP信息或不做任何操作使请求无效。目的是将用户引导至非预期目标，或禁止用户访问。DNS劫持流程如图10.1.1所示:

![image-20220226110544931](/Users/changzw/Library/Application Support/typora-user-images/image-20220226110544931.png)

DNS劫持一般只会发生在特定的网络范围内，大部分集中在使用默认DNS服务器上网的用户。因此，我们**可以通过直接访问目标IP，或设置正确的DNS服务器来绕过DNS劫持**。



#### 2.HTTP劫持

HTTP（Hyper Text Transfer Protocol，超文本传输协议）工作在OSI模型的应用层，用于万维网数据通信。HTTP协议基于C/S架构，客户端主要为浏览器，服务器为Nginx等中间件

HTTP劫持发生在运营商网络节点上。对流量进行检测，当流量协议为HTTP时，进行拦截处理。HTTP劫持流程如图10.1.4所示，步骤如下：

（1）获取网络流量，并在其中标识出HTTP协议流量；

（2）拦截服务器响应包，对响应包的内容进行篡改；

（3）将篡改之后的数据包抢先于正常响应包返回给客户端；

（4）客户端先接收篡改的数据包，并将后面正常的响应包丢弃。

<img src="/Users/changzw/Library/Application Support/typora-user-images/image-20220226111018614.png" alt="image-20220226111018614" style="zoom:50%;" />

上述劫持过程实际可以理解为TCP劫持的一部分。在常规的HTTP劫持中，攻击者一般会通过入侵源服务器，在网站内植入恶意JavaScript脚本。当用户正常访问源服务器时，被篡改的网站源码会运行跳转到指定的恶意网站。

#### 3.链路层劫持

数据链路层是OSI参考模型中的第二层，介于物理层和网络层之间。数据链路层在物理层提供的服务的基础上向网络层提供服务，其最基本的服务是将源网络层的数据可靠地传输到相邻节点的目标机网络层。链路层劫持是指攻击者在受害者至目标服务器之间，恶意植入或控制网络设备，以达到监听或篡改流量数据的目的。

##### 1）TCP劫持

TCP会话劫持的原理是劫持客户端与服务端已经建立的TCP通信，并伪造其中一方，以达到嗅探侦听、篡改流量数据、控制服务端的目的。

##### 2）ARP劫持

ARP（Address Resolution Protocol，地址解析协议）



### 10.1.3　常见攻击场景

#### 1.DNS劫持

DNS劫持的攻击目标为提供DNS解析的设备或文件。因此，常见的DNS劫持攻击手法分为：本地DNS劫持、路由器DNS劫持、中间人DNS攻击、恶意DNS服务器攻击。

（1）本地DNS劫持，通过修改本地hosts文件、更改本地DNS设置（非流量劫持）实现攻击。

（2）路由器DNS劫持，利用弱密码、固件漏洞等，攻击路由器，更改路由器DNS设置。

（3）中间人DNS攻击，通过拦截DNS查询请求，返回虚假IP，实现攻击。

（4）恶意DNS服务器攻击，即通过直接攻击DNS服务器，更改DNS记录。通过以下案例，我们可以窥探到DNS劫持的黑色产业链。2019年5月23日，国家互联网应急中心发布通报，境内400多万台家用路由器DNS地址被篡改至江苏省内多个IP地址，造成用户在访问部分网站时会被劫持至涉赌网站，社会影响恶劣。攻击者通过网络在全国各地租用服务器，并按照每个域名200元的价格，为境外博彩网站提供301跳转和CDN加速服务，从中获利。

#### 2.HTTP劫持

HTTP劫持的关键点在于识别HTTP协议，并进行标识。因此，HTTP劫持方法较为单一，主要目的如下：

（1）嗅探侦听流量，伪造HTTP响应；

（2）钓鱼攻击；

（3）灰产广告引流。

HTTP劫持更多发生在服务端网站被入侵后，攻击者植入了恶意代码实现跳转，较常见的场景有：在通过搜索引擎访问网站时发生跳转，但在直接访问网站时并不会跳转，这是因为攻击者在植入的恶意代码中加入了对HTTP请求头Referer内容的判断。

#### 3.链路层劫持

##### 1）TCP劫持

TCP劫持的主要目的如下：

（1）嗅探侦听流量，窃密；

（2）访问限制，重定向导致断网或者钓鱼攻击；

（3）灰产广告引流。

更多的TCP劫持主要发生在运营商层面，用户在上网冲浪时，浏览器的右下角总是会出现各种各样的小广告。目前，在网络上仍存在类似的灰产组织，通过某些通信工具依旧可以发现他们的踪迹，如图10.1.5所示：

<img src="/Users/changzw/Library/Application Support/typora-user-images/image-20220226111433314.png" alt="image-20220226111433314" style="zoom:50%;" />

##### 2）ARP劫持

ARP劫持多用于局域网攻击，主要目的如下：

（1）嗅探侦听流量，窃密；

（2）阻断用户网络连接。如比较经典的ARP病毒“传奇网吧杀手”，该病毒作者破解了“传奇”游戏的加、解密算法，通过分析游戏的通信协议，在网吧内作案，窃取同在一个网吧局域网内的“传奇”游戏玩家的详细信息。

### 10.1.4　流量劫持防御方法

#### 1.DNS劫持防御

根据DNS劫持常见的攻击手法，可采取相应的防护方法进行防御。

（1）锁定hosts文件，不允许修改。

（2）配置本地DNS为自动获取，或将其设置为可信DNS服务器。

（3）路由器采用强密码策略。

（4）及时更新路由器固件。

（5）使用加密协议进行DNS查询。

#### 2.HTTP劫持防御

使用HTTPS进行数据交互。

#### 3.链路层劫持防御

##### 1）TCP劫持

（1）使用加密通信，如使用SSL代替HTTP，或者使用IPSec-VPN等方法实现端到网关、端到端、网关到网关等场景下的通信加密。

（2）避免使用共享式网络。

##### 2）ARP劫持

（1）避免使用共享式网络。

（2）将IP地址和MAC地址静态绑定。

（3）使用具有ARP防护功能的终端安全软件。

（4）使用具有ARP防护功能的网络设备。



## 10.4技术操作指南

10.4.1　初步预判

首先需要确定是否遭遇流量劫持。当出现以下情况时，表示很可能遭遇流量劫持。

（1）网页带有广告或其他引流特性信息。

（2）浏览器经常接收到不同服务器返回的3××的重定向类HTTP状态码，并跳转至恶意页面。

（3）之前能正常访问的网站突然无法访问，或者访问出错。切换IP或DNS设置后可以正常访问。

（4）网络中存在大量异常流量，如大量ARP响应报文、缺失的TCP报文等。

（5）无法正常上网。

可通过以下方法判断当前流量劫持的类型。

（1）DNS劫持：当切换运营商网络或DNS设置后，访问恢复正常。

（2）HTTP劫持：使用浏览器F12功能监听网络流量与脚本文件，观察响应是否发生在源服务器的本地资源。

（3）链路层劫持：TCP劫持一般发生在互联网访问时，出现广告引流现象，当切换运营商网络或物理位置后，恢复正常；ARP劫持一般发生在局域网内，可以使用抓包工具，发现大量异常的ARP请求。

### 10.4.2　DNS劫持排查

DNS劫持主要通过计算机hosts文件篡改、路由器或其他网络设备DNS设置篡改、DNS服务器缓存污染等手段实现劫持攻击。因此，我们可以针对性地进行排查。

#### 1.排查本地信息

hosts文件是计算机系统中一个记录IP与域名对应关系的文件，可帮助用户快速解析域名。用户在访问域名网站时，会先在本地查询hosts文件，若存在对应关系，则直接访问；若不存在对应关系，则请求DNS服务器。hosts文件内容格式如下：

![image-20220226144033544](/Users/changzw/Library/Application Support/typora-user-images/image-20220226144033544.png)

其中，IP地址、主机或域名是必需的信息，后面可以跟一个或多个主机的别名，不同字段之间用一个或多个空格分隔。hosts文件中可以有注释，每行#后面的内容会被系统视为注释。一般，在系统hosts文件中，至少应有以下内容：127.0.0.1localhost localhost.localdomain，表示localhost与本机IP 127.0.0.1为对应关系。

在Linux系统中，hosts文件的路径为/etc/hosts，如图10.4.2所示。

<img src="/Users/changzw/Library/Application Support/typora-user-images/image-20220226112501665.png" alt="image-20220226112501665" style="zoom:50%;" />

若在排查中发现了其他内容或存在修改情况，则需要重点排查并确认是否出现恶意篡改。图10.4.3中，192.168.1.1 *.qianxin.com表示将访问任何qianxin.com域名的请求指向192.168.1.1，这样就实现了对qianxin.com的劫持。

<img src="/Users/changzw/Library/Application Support/typora-user-images/image-20220226112603106.png" alt="image-20220226112603106" style="zoom:50%;" />

#### 2.排查本地网卡DNS配置信息

在Windows系统中，打开【网络连接】窗口，双击【以太网】选项，在打开的对话框中单击【详细信息】按钮查看详情。通常情况下，DNS服务器为自动获取。若为手动填写，则需要检查该处内容是否为本机最初设定的地址，如果发现有改动，可以通过网络检查服务器地址是否异常。如图10.4.4所示，10.211.55.1是一个不可信地址。

在Linux系统中，可使用【cat/etc/resolv.conf】命令查看/etc/resolv.conf文件，如图10.4.5所示。检查是否被篡改的方法与Windows系统类似。

<img src="/Users/changzw/Library/Application Support/typora-user-images/image-20220226112803212.png" alt="image-20220226112803212" style="zoom:50%;" />

<img src="/Users/changzw/Library/Application Support/typora-user-images/image-20220226112822460.png" alt="image-20220226112822460" style="zoom:50%;" />

#### 3.排查异常DNS服务器

使用【nslookup】命令，并使用server选项设置不同的DNS服务器，可解析域名。当某个DNS服务器响应与其他DNS服务器不同时，即可初步确认该DNS出现问题。

以下使用3个DNS服务器进行举例。192.168.240.131为恶意的DNS服务器，在此DNS服务器中绑定www.qianxin.com域名解析111.111.111.111，8.8.8.8为Google提供的免费DNS服务器，114.114.114.114为电信提供的全国通用DNS服务器。现在用户默认使用192.168.240.131 DNS服务器上网，发现www.qianxin.com无法正常访问。通过【Ping】命令发现域名解析为111.111.111.111，如图10.4.6所示。

![image-20220226113007929](/Users/changzw/Library/Application Support/typora-user-images/image-20220226113007929.png)

使用【nslookup】命令检查DNS服务器，发现使用的DNS服务器为192.168.240.131，如图10.4.7所示。解析www.qiaxin.com的IP地址为111.111.111.111，如图10.4.8所示。

![image-20220226113037578](/Users/changzw/Library/Application Support/typora-user-images/image-20220226113037578.png)

![image-20220226113050001](/Users/changzw/Library/Application Support/typora-user-images/image-20220226113050001.png)

输入【server 8.8.8.8】或【server 114.114.114.114】命令，设置DNS服务器为Google或电信，解析www.qianxin.com的IP地址为219.153.112.70，如图10.4.9所示。由此可以判断原先默认使用的192.168.240.131 DNS服务器错误地解析了www.qianxin.com域名，判断用户被DNS劫持。

![image-20220226113112709](/Users/changzw/Library/Application Support/typora-user-images/image-20220226113112709.png)

### 10.4.3　HTTP劫持排查

在排查前，可先检查劫持是否因为网站被恶意入侵，攻击者篡改了网站源码所致。打开浏览器，按【F12】键，打开【Network】功能，监测网站加载的本地静态资源与外部资源，从而可判断是在哪一步发生的跳转。在使用【Network】功能时，要注意勾选【Preserve log】复选框，之后在【Initiator】中查看【Request callstack】，如图10.4.10所示。排查发现用户首先访问file：///C：/Users/×××/Desktop/1.html页面，之后立刻跳转到百度网页，Request call stack标注问题来自1.html文件的第18行。

![image-20220226113156751](/Users/changzw/Library/Application Support/typora-user-images/image-20220226113156751.png)

10.4.4　TCP劫持排查TCP劫持事件多为抢先回包劫持会话。如果发生劫持，使用抓包工具（Wireshark）捕获浏览器访问的链路层流量，可发现对浏览器产生的单个请求，同时会收到两个不同的TCP响应报文，因为伪造的第1个数据包先到，所以第2个正常的TCP响应数据包被客户端忽略了。图10.4.12是先到的伪造数据包，图10.4.13是被忽略的数据包。观察两个TCP响应报文的数据部分，可见较早回复的数据包是来自劫持源的虚假响应报文，来自真实服务器的回复报文由于到达较晚，因此被认为是TCP重传包并被丢弃。真实数据包的TTL是244，ID是按顺序自增的；伪造数据包的TTL是57，ID始终是0。

![image-20220226144301672](/Users/changzw/Library/Application Support/typora-user-images/image-20220226144301672.png)

![image-20220226144320454](/Users/changzw/Library/Application Support/typora-user-images/image-20220226144320454.png)

大部分TCP劫持被用于篡改HTTP响应内容，投放的内容多为游戏、色情、赌博等领域广告。攻击者一般通过旁路设备监听链路流量，实现劫持。也有的攻击者会利用攻击设备，在链路内捕获用户的正常访问流量，记录用户敏感信息，从而进行广告推广、电信诈骗等。



##### 可使用网站http://wzjk.iis7.net/来查询是否网站被流量劫持